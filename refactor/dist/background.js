(()=>{"use strict";({545:function(){var e=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(n,s){function i(e){try{c(o.next(e))}catch(e){s(e)}}function a(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(i,a)}c((o=o.apply(e,r||[])).next())}))};function r(t){return e(this,arguments,void 0,(function*(e,t=3,o=1e3){try{return yield e()}catch(n){if(0===t)throw n;return yield new Promise((e=>setTimeout(e,o))),r(e,t-1,2*o)}}))}function t(t){return e(this,void 0,void 0,(function*(){try{const{openaiApiKey:o,savedForms:n=[]}=yield chrome.storage.local.get(["openaiApiKey","savedForms"]);if(!o)throw new Error("No API key found. Please set your OpenAI API key in the extension options.");const s=JSON.stringify(n,null,2),i=yield fetch(chrome.runtime.getURL("prompt.md"));if(!i.ok)throw new Error("Failed to load prompt template");const a=(yield i.text()).replace("${userPrompt}",t.prompt).replace("${pageDom}",t.pageDom).replace("${savedFormData}",s),c=()=>e(this,void 0,void 0,(function*(){var e;const r=yield fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({model:"gpt-4o",messages:[{role:"system",content:a}],temperature:.8,max_tokens:1024,top_p:1,frequency_penalty:0,presence_penalty:0,response_format:{type:"json_object"}})});if(!r.ok){const t=yield r.json();throw new Error(`OpenAI API error: ${(null===(e=t.error)||void 0===e?void 0:e.message)||"Unknown error"}`)}return r.json()})),l=(yield r(c)).choices[0].message.content,d=JSON.parse(l);if(!d.fields||!Array.isArray(d.fields))throw new Error("Invalid response format: missing or invalid fields array");return d.fields.forEach(((e,r)=>{if(!e.selector||!e.value||!e.display_name)throw new Error(`Invalid field format at index ${r}`)})),d}catch(e){throw console.error("Error in handleLLMCall:",e),e}}))}chrome.runtime.onMessage.addListener(((r,o,n)=>"PROCESS_PROMPT"===r.type?(t(r).then((e=>n(Object.assign({success:!0},e)))).catch((e=>n({success:!1,error:e.message,details:e.stack}))),!0):"SAVE_FORM_DATA"===r.type&&(function(r){return e(this,void 0,void 0,(function*(){try{const{savedForms:e=[]}=yield chrome.storage.local.get(["savedForms"]),t=[Object.assign(Object.assign({},r),{timestamp:(new Date).toISOString(),url:r.url||"unknown"}),...e].slice(0,50);yield chrome.storage.local.set({savedForms:t});const{userInfo:o={}}=yield chrome.storage.local.get(["userInfo"]),n=Object.assign({},o);Object.entries(r.fields).forEach((([e,r])=>{if(r.label&&r.value){const e=r.label.replace(/([A-Z])/g," $1").replace(/[_-]/g," ").trim().split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase())).join(" ");n[e]=r.value}})),yield chrome.storage.local.set({userInfo:n})}catch(e){throw console.error("Error in saveFormData:",e),e}}))}(r.formData).then((()=>n({success:!0}))).catch((e=>n({success:!1,error:e.message}))),!0)))}})[545]()})();